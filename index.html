<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chat CS RobuxNow</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
<style>
  @import url('https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700&display=swap');
  * { box-sizing: border-box; }
  body {
    margin: 0;
    font-family: 'Rubik', sans-serif;
    background-color: #f0f2f5;
    color: #333;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
  }
  .chat-container {
    width: 100%;
    max-width: 420px;
    height: 100vh;
    display: flex;
    flex-direction: column;
    background-color: white;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
    position: relative;
  }
  .chat-header {
    background: #00b0ff;
    color: white;
    padding: 15px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  }
  .chat-header .left {
    display: flex;
    align-items: center;
  }
  .chat-header .download-icon {
    font-size: 24px;
    margin-right: 15px;
    cursor: pointer;
  }
  .chat-header h1 {
    font-size: 1.1rem;
    font-weight: 500;
    margin: 0;
  }
  .chat-header .status {
    font-size: 0.8rem;
    opacity: 0.8;
  }
  .chat-header .version {
    font-size: 0.7rem;
    font-weight: normal;
  }
  .messages {
    flex: 1;
    overflow-y: auto;
    padding: 10px;
    background-color: #e5ddd5;
    background-image: url('https://raw.githubusercontent.com/Amak-0/live-chat/main/wallpaper.png'); 
    background-size: cover; 
    background-position: center; 
  }
  .messages::-webkit-scrollbar { width: 4px; }
  .messages::-webkit-scrollbar-thumb { background-color: #b0a9a1; border-radius: 2px; }
  .message-wrapper {
    display: flex;
    margin-bottom: 15px;
    align-items: flex-start;
  }
  .avatar {
    width: 35px;
    height: 35px;
    border-radius: 50%;
    object-fit: cover;
    margin-right: 10px;
  }
  .message {
    padding: 10px 12px;
    border-radius: 8px;
    position: relative;
    max-width: 80%;
    font-size: 0.9rem;
    word-wrap: break-word;
    box-shadow: 0 1px 1px rgba(0,0,0,0.08);
  }
  .message.user {
    background-color: #dcf8c6;
    margin-left: auto;
    border-bottom-right-radius: 0;
  }
  .message.agent {
    background-color: white;
    border-bottom-left-radius: 0;
  }
  .sender-name {
    font-weight: bold;
    font-size: 0.8rem;
    color: #075e54;
    margin-bottom: 2px;
  }
  .time {
    font-size: 0.65rem;
    color: #888;
    margin-top: 5px;
    text-align: right;
  }
  .info-message {
    text-align: center;
    color: #888;
    font-size: 0.7rem;
    margin: 15px 0;
  }
  .chat-input {
    display: flex;
    padding: 8px;
    background-color: #f0f2f5;
    border-top: 1px solid #ddd;
    gap: 8px;
  }
  .chat-input input {
    flex: 1;
    border: none;
    padding: 12px 18px;
    border-radius: 20px;
    background-color: white;
    outline: none;
    font-size: 0.9rem;
  }
  .chat-input button {
    background-color: #00b0ff;
    color: white;
    border: none;
    width: 45px;
    height: 45px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 1.2rem;
    transition: background-color 0.3s;
  }
  .chat-input button:hover {
    background-color: #0088cc;
  }
  .initial-form-container {
    padding: 15px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    flex: 1;
  }
  .pilihan-buttons {
      display: flex;
      flex-direction: column;
      gap: 5px;
      margin-top: 5px;
  }
  .pilihan-buttons button {
      background-color: #f0f0f0;
      border: 1px solid #ccc;
      border-radius: 20px;
      padding: 8px 12px;
      font-size: 0.9rem;
      cursor: pointer;
      text-align: left;
      transition: background-color 0.3s;
  }
  .pilihan-buttons button:hover {
      background-color: #e0e0e0;
  }
</style>
</head>
<body>

<div class="chat-container">
  <div class="chat-header">
    <div class="left">
      <i class="fas fa-arrow-left"></i>
      <div style="margin-left: 15px;">
        <h1 id="chat-partner-name">Agent</h1>
        <div class="status" id="departemen-status">Pilih Departemen</div>
      </div>
    </div>
    <div class="right">
      <span class="version">0.5.0</span>
    </div>
  </div>

  <div class="messages" id="messages">
    <div class="info-message">
      </div>
  </div>

  <div class="chat-input" id="initial-chat-input">
    <div class="initial-form-container">
      <select id="pilihan-departemen">
        <option value="" disabled selected>Pilih Departemen</option>
        <option value="Technical Support">Technical Support</option>
        <option value="Sales">Sales</option>
        <option value="Billing">Billing</option>
      </select>
      <input type="text" id="nama" placeholder="Tulis Nama Anda">
    </div>
  </div>

  <div class="chat-input" id="main-chat-input" style="display: none;">
    <input type="text" id="pesan" placeholder="Tulis pesan..." autocomplete="off">
    <button onclick="kirimPesan()"><i class="fas fa-paper-plane"></i></button>
  </div>
</div>

<audio id="notifSound" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg" preload="auto"></audio>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import { getDatabase, ref, push, onChildAdded, set, onValue } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAcFRkbZT3PD3BDObS-7T1769uH5Macvd0",
    authDomain: "reystore-support.firebaseapp.com",
    databaseURL: "https://reystore-support-default-rtdb.firebaseio.com",
    projectId: "reystore-support",
    storageBucket: "reystore-support.firebasestorage.app",
    messagingSenderId: "446513200960",
    appId: "1:446513200960:web:cbd40ca4315a8bf47044a5",
    measurementId: "G-YEBFKLREK5"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  let chatId = null;
  let adminName = "Agent";
  let userDepartemen = "";

  const messagesDiv = document.getElementById("messages");
  const notifSound = document.getElementById("notifSound");
  const namaInput = document.getElementById('nama');
  const pilihanDepartemen = document.getElementById('pilihan-departemen');
  const pesanInput = document.getElementById('pesan');
  const chatPartnerNameHeader = document.getElementById('chat-partner-name');
  const departemenStatus = document.getElementById('departemen-status');
  const initialChatInput = document.getElementById('initial-chat-input');
  const mainChatInput = document.getElementById('main-chat-input');
  const infoMessageDiv = document.querySelector('.info-message');

  if ("Notification" in window && Notification.permission !== "granted") {
    Notification.requestPermission();
  }

  function formatTime(timestamp) {
    const date = new Date(timestamp);
    const options = { hour: '2-digit', minute: '2-digit', hour12: false, timeZone: 'Asia/Jakarta' };
    return date.toLocaleTimeString('id-ID', options);
  }

  function showNotification(text) {
    notifSound.play();
    if (navigator.vibrate) navigator.vibrate(200);
    if (document.hidden && "Notification" in window && Notification.permission === "granted") {
      new Notification("Pesan Baru", { body: text, icon: "wallpaper.png" });
    }
  }

  function addBubble(sender, text, time, name) {
    const wrapper = document.createElement("div");
    wrapper.className = `message-wrapper ${sender}`;
    
    let avatarHtml = '';
    if (sender === 'agent') {
      avatarHtml = `<img src="https://example.com/agent-avatar.png" alt="Avatar Agent" class="avatar">`;
    }
    
    const bubble = document.createElement("div");
    bubble.className = `message ${sender}`;
    
    // Check for "pilihan" buttons from admin
    if (sender === 'agent' && text.startsWith('[pilihan:')) {
        const optionsText = text.substring(9, text.length - 1);
        const optionsArray = optionsText.split('|');
        let buttonsHtml = `<div class="pilihan-buttons">`;
        optionsArray.forEach(option => {
            buttonsHtml += `<button onclick="handlePilihan('${option}')">${option}</button>`;
        });
        buttonsHtml += '</div>';
        bubble.innerHTML = buttonsHtml + `<div class="time">${formatTime(time)}</div>`;
    } else {
        if (name) {
          bubble.innerHTML = `<div class="sender-name">${name}</div>${text}<div class="time">${formatTime(time)}</div>`;
        } else {
          bubble.innerHTML = `${text}<div class="time">${formatTime(time)}</div>`;
        }
    }

    if (sender === 'agent') {
      wrapper.innerHTML = avatarHtml + bubble.outerHTML;
    } else {
      wrapper.appendChild(bubble);
    }
    
    messagesDiv.appendChild(wrapper);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
    if (sender === "agent") showNotification(text);
  }
  
  // Fungsi baru untuk menangani pilihan yang diklik user
  window.handlePilihan = function(pilihan) {
      pesanInput.value = pilihan; // Isi input pesan dengan pilihan yang diklik
      kirimPesan(); // Kirim pesan tersebut
  };

  function addInfoMessage(text) {
    const div = document.createElement('div');
    div.className = 'info-message';
    div.innerText = text;
    messagesDiv.appendChild(div);
  }
  
  function tampilkanInputPesan() {
    initialChatInput.style.display = 'none';
    mainChatInput.style.display = 'flex';
    pesanInput.focus();
  }
  
  function tampilkanInputNama() {
    initialChatInput.style.display = 'flex';
    mainChatInput.style.display = 'none';
    namaInput.focus();
  }

  async function kirimPesan() {
    let pesan = pesanInput.value.trim();
    const nama = localStorage.getItem('chatUsername');

    if (!pesan) {
      alert("Pesan tidak boleh kosong!");
      return;
    }
    
    if (!chatId) {
      chatId = localStorage.getItem('chatId');
      if (!chatId) {
        chatId = push(ref(db, "chats")).key;
        localStorage.setItem('chatId', chatId);
        set(ref(db, "chats/" + chatId + "/username"), nama);
        set(ref(db, "chats/" + chatId + "/departemen"), userDepartemen);
      }
      
      const chatRef = ref(db, "chats/" + chatId);
      onValue(chatRef, (snapshot) => {
        const chatData = snapshot.val();
        if (chatData && chatData.adminName) {
            adminName = chatData.adminName;
            chatPartnerNameHeader.innerText = `${adminName} - ${userDepartemen}`;
            infoMessageDiv.innerText = `Terhubung dengan ${adminName}, departemen ${userDepartemen}`;
        }
      });

      onChildAdded(ref(db, "chats/" + chatId + "/messages"), (snap) => {
        const d = snap.val();
        addBubble(d.sender, d.text, d.time, d.sender === 'user' ? nama : adminName);
      });
    }

    const msgRef = push(ref(db, "chats/" + chatId + "/messages"));
    set(msgRef, { sender: "user", text: pesan, time: Date.now() });
    
    pesanInput.value = "";
  }
  
  function mulaiChat() {
    const nama = namaInput.value.trim();
    userDepartemen = pilihanDepartemen.value;

    if (!nama || !userDepartemen) {
      alert("Harap isi nama dan pilih departemen terlebih dahulu!");
      return;
    }
    
    localStorage.setItem('chatUsername', nama);
    localStorage.setItem('chatDepartemen', userDepartemen);

    departemenStatus.innerText = userDepartemen;
    chatPartnerNameHeader.innerText = `Agent - ${userDepartemen}`;
    infoMessageDiv.innerText = `Terhubung dengan Agent, departemen ${userDepartemen}`;

    tampilkanInputPesan();
    
    // Kirim pesan pertama
    const pesanAwal = `Halo, saya ${nama}. Saya butuh bantuan untuk masalah ${userDepartemen}.`;
    pesanInput.value = pesanAwal;
    kirimPesan();
  }

  function muatChatTersimpan() {
    chatId = localStorage.getItem('chatId');
    const namaTersimpan = localStorage.getItem('chatUsername');
    userDepartemen = localStorage.getItem('chatDepartemen');

    if (chatId && namaTersimpan && userDepartemen) {
      tampilkanInputPesan();
      departemenStatus.innerText = userDepartemen;
      
      const chatRef = ref(db, "chats/" + chatId);
      onValue(chatRef, (snapshot) => {
        const chatData = snapshot.val();
        if (chatData && chatData.adminName) {
            adminName = chatData.adminName;
            chatPartnerNameHeader.innerText = `${adminName} - ${userDepartemen}`;
            infoMessageDiv.innerText = `Terhubung dengan ${adminName}, departemen ${userDepartemen}`;
        } else {
            chatPartnerNameHeader.innerText = `Agent - ${userDepartemen}`;
            infoMessageDiv.innerText = `Terhubung dengan Agent, departemen ${userDepartemen}`;
        }
      });
      
      onChildAdded(ref(db, "chats/" + chatId + "/messages"), (snap) => {
        const d = snap.val();
        addBubble(d.sender, d.text, d.time, d.sender === 'user' ? namaTersimpan : adminName);
      });
      
    } else {
      tampilkanInputNama();
    }
  }

  document.addEventListener('DOMContentLoaded', muatChatTersimpan);
  
  window.kirimPesan = kirimPesan;

  pilihanDepartemen.addEventListener('change', () => {
    if (pilihanDepartemen.value !== '') {
      namaInput.focus();
    }
  });
  
  namaInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      mulaiChat();
    }
  });

  pesanInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      kirimPesan();
    }
  });

</script>
</body>
</html>
